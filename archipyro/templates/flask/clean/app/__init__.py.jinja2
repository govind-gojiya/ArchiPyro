import os
from flask import Flask
from app.config import config
from app.extensions import init_extensions

def create_app(config_name=None):
    """
    Application factory pattern.
    
    Args:
        config_name: Configuration name (development, testing, production).
                     If None, reads from FLASK_ENV environment variable.
    
    Returns:
        Flask application instance
    """
    app = Flask(__name__)
    
    # Get config name from environment variable if not provided
    if config_name is None:
        config_name = os.environ.get('FLASK_ENV', 'default')
    
    # Validate config name
    if config_name not in config:
        raise ValueError(f"Invalid configuration name: {config_name}. Must be one of: {list(config.keys())}")
    
    app.config.from_object(config[config_name])

    # Initialize logging
    {%- if "Logging Setup" in config.features %}
    from app.logging_config import setup_logging
    setup_logging(
        log_level=app.config.get('LOG_LEVEL', 'INFO'),
        log_file=app.config.get('LOG_FILE', 'app.log')
    )
    {%- endif %}

    # Initialize extensions
    init_extensions(app)

    # Register error handlers
    from app.exceptions import register_error_handlers
    register_error_handlers(app)

    # Register blueprints
    from app.routes import api_bp
    app.register_blueprint(api_bp, url_prefix='/api')

    return app
