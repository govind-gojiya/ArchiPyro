"""
Custom exception classes and error handlers.
"""
from flask import jsonify, Response, request
from werkzeug.exceptions import MethodNotAllowed
from typing import Tuple
import logging

logger = logging.getLogger(__name__)

from .base import BaseAPIException
from .validation import ValidationError
from .not_found import NotFoundError
from .unauthorized import UnauthorizedError


def register_error_handlers(app):
    """
    Register error handlers for the Flask application.
    
    Args:
        app: Flask application instance
    """
    @app.errorhandler(BaseAPIException)
    def handle_api_exception(error: BaseAPIException) -> Tuple[Response, int]:
        """Handle custom API exceptions."""
        logger.warning(f"API Exception: {error.message} (Status: {error.status_code})")
        response = jsonify({
            'success': False,
            'message': error.message,
            'errors': error.errors if hasattr(error, 'errors') else None
        })
        response.status_code = error.status_code
        return response

    @app.errorhandler(404)
    def handle_not_found(error) -> Tuple[Response, int]:
        """Handle 404 errors."""
        logger.warning(f"404 Not Found: {request.method} {request.path}")
        return jsonify({
            'success': False,
            'message': 'Resource not found'
        }), 404

    @app.errorhandler(405)
    def handle_method_not_allowed(error: MethodNotAllowed) -> Tuple[Response, int]:
        """Handle 405 Method Not Allowed errors."""
        allowed_methods = getattr(error, 'valid_methods', [])
        method = request.method
        path = request.path
        
        logger.warning(
            f"405 Method Not Allowed: {method} {path}. "
            f"Allowed methods: {', '.join(allowed_methods) if allowed_methods else 'None'}"
        )
        
        response_data = {
            'success': False,
            'message': f'Method {method} is not allowed for this endpoint',
            'allowed_methods': allowed_methods if allowed_methods else []
        }
        
        response = jsonify(response_data)
        response.status_code = 405
        
        # Add Allow header with allowed methods (HTTP standard)
        if allowed_methods:
            response.headers['Allow'] = ', '.join(allowed_methods)
        
        return response

    @app.errorhandler(400)
    def handle_bad_request(error) -> Tuple[Response, int]:
        """Handle 400 Bad Request errors."""
        logger.warning(f"400 Bad Request: {request.method} {request.path} - {str(error)}")
        return jsonify({
            'success': False,
            'message': 'Bad request - invalid input data'
        }), 400

    @app.errorhandler(403)
    def handle_forbidden(error) -> Tuple[Response, int]:
        """Handle 403 Forbidden errors."""
        logger.warning(f"403 Forbidden: {request.method} {request.path}")
        return jsonify({
            'success': False,
            'message': 'Access forbidden - insufficient permissions'
        }), 403

    @app.errorhandler(500)
    def handle_internal_error(error) -> Tuple[Response, int]:
        """Handle 500 errors."""
        logger.error(f"Internal server error: {str(error)}", exc_info=True)
        return jsonify({
            'success': False,
            'message': 'Internal server error'
        }), 500

    @app.errorhandler(Exception)
    def handle_generic_exception(error: Exception) -> Tuple[Response, int]:
        """Handle unhandled exceptions."""
        logger.error(f"Unhandled exception: {str(error)}", exc_info=True)
        return jsonify({
            'success': False,
            'message': 'An unexpected error occurred'
        }), 500

